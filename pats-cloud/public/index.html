<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pats Cloud</title>
  <link rel="icon" href="data:," />
  <style>
    :root {
      --bg: #0b0f14;
      --surface: #121821;
      --surface-2: #0e141c;
      --text: #e6edf3;
      --muted: #9fb3c8;
      --primary: #60a5fa;
      --primary-2: #2563eb;
      --danger: #ef4444;
      --success: #22c55e;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial;
      background: radial-gradient(1200px 800px at 10% -10%, #0b1220, var(--bg)),
                  radial-gradient(800px 600px at 120% 20%, #0b1426, transparent);
      color: var(--text);
      display: grid; place-items: center;
      line-height: 1.3;
    }
    .app {
      width: min(960px, 100%);
      padding: 16px;
    }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius);
      box-shadow: 0 20px 60px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    header.card { padding: 16px 18px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    header h1 { font-size: clamp(18px, 5vw, 22px); margin: 0; letter-spacing: 0.4px; }
    .muted { color: var(--muted); font-size: 12px; }
    .content.card { margin-top: 14px; padding: 14px; }

    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .right { display: flex; gap: 10px; align-items: center; justify-content: flex-end; flex-wrap: wrap; }

    input[type="password"], input[type="text"], .btn, .file-input {
      border-radius: 12px; border: 1px solid rgba(255,255,255,0.14);
      background: var(--surface);
      color: var(--text);
      padding: 12px 14px; font-size: 14px;
    }
    .btn { background: linear-gradient(180deg, var(--primary), var(--primary-2)); border: none; color: white; cursor: pointer; line-height: 1; display: inline-flex; align-items: center; justify-content: center; }
    .file-input { display: inline-flex; align-items: center; justify-content: center; }
    .btn.secondary { background: linear-gradient(180deg, #303a49, #202834); }
    .btn.danger { background: linear-gradient(180deg, #f87171, #ef4444); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .file-drop {
      border: 1.5px dashed rgba(255,255,255,0.2);
      border-radius: 14px;
      padding: 18px; text-align: center; color: var(--muted);
      background: var(--surface-2);
    }

    ul.files { list-style: none; margin: 0; padding: 0; display: grid; gap: 10px; }
    .file {
      display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center;
      padding: 10px; border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.08);
    }
    .file .meta { display: flex; gap: 10px; align-items: center; min-width: 0; }
    .file .meta > * { line-height: 1.2; vertical-align: middle; }
    .file .name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .file .actions { display: flex; gap: 6px; align-items: center; }

    .upload-item { padding: 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: var(--surface-2); }
    .progress { height: 8px; background: rgba(255,255,255,0.12); border-radius: 999px; overflow: hidden; }
    .progress > div { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--primary-2)); transition: width 0.15s ease; }
    .small { font-size: 12px; color: var(--muted); line-height: 1.2; }

    .spacer { flex: 1; }
    .hidden { display: none !important; }

    @media (hover: hover) {
      .file:hover { border-color: rgba(255,255,255,0.22); }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="card">
      <h1>ðŸ˜» Pats Cloud</h1>
      <div class="right">
        <small id="storage" class="muted" style="text-align:right"></small>
        <small id="status" class="muted">Not signed in</small>
        <button id="logoutBtn" class="btn secondary hidden">Logout</button>
      </div>
    </header>

    <section id="loginView" class="content card">
      <div class="row">
        <input id="password" type="password" inputmode="text" placeholder="Enter password" style="flex:1" />
        <button id="loginBtn" class="btn">Sign In</button>
      </div>
      <p class="muted" style="margin-top:8px">Keep this private. You can set the password via .env</p>
    </section>

    <section id="appView" class="content card hidden">
      <div class="row" style="gap:8px; align-items: stretch;">
        <label class="file-input" style="display:inline-flex; align-items:center; gap:10px; cursor:pointer;">
          <input id="fileInput" type="file" multiple style="display:none" />
          <span>Choose files</span>
        </label>
        <div class="spacer"></div>
        <div class="row" id="tabs" style="gap:6px">
          <button class="btn secondary" data-sort="recent">Recent</button>
          <button class="btn secondary" data-sort="name">Name</button>
          <button class="btn secondary" data-sort="size">Size</button>
        </div>
        <button id="refreshBtn" class="btn secondary">Refresh</button>
      </div>

      <div id="drop" class="file-drop" style="margin-top:10px">Drop files here to upload</div>

      <ul id="fileList" class="files" style="margin-top:12px"></ul>

      <div id="uploadsContainer" style="margin-top:12px">
        <div class="small">In progress</div>
        <ul id="uploads" class="files"></ul>
      </div>
    </section>
  </div>

  <script>
    const loginView = document.getElementById('loginView');
    const appView = document.getElementById('appView');
    const statusEl = document.getElementById('status');
    const storageEl = document.getElementById('storage');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginBtn = document.getElementById('loginBtn');
    const passwordEl = document.getElementById('password');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const drop = document.getElementById('drop');
    const refreshBtn = document.getElementById('refreshBtn');
    const uploadsList = document.getElementById('uploads');
    const tabs = document.getElementById('tabs');

    let authed = false;
    let currentSort = 'recent';
    let currentFiles = [];

    async function api(path, opts = {}) {
      const res = await fetch(path, {
        ...opts,
        headers: {
          'Content-Type': 'application/json',
          ...(opts.headers || {}),
        },
        credentials: 'same-origin',
      });
      if (!res.ok) throw new Error(await res.text());
      return res.headers.get('content-type')?.includes('application/json') ? res.json() : res.text();
    }

    function setLoggedIn(v) {
      authed = v;
      loginView.classList.toggle('hidden', v);
      appView.classList.toggle('hidden', !v);
      logoutBtn.classList.toggle('hidden', !v);
      statusEl.textContent = v ? 'Signed in' : 'Not signed in';
      if (v) loadStorage(); else storageEl.textContent = '';
    }

    loginBtn.addEventListener('click', async () => {
      try {
        const body = JSON.stringify({ password: passwordEl.value });
        const data = await api('/login', { method: 'POST', body });
        setLoggedIn(true);
        if (data?.warning) alert(data.warning);
        await loadFiles();
      } catch (e) {
        alert('Login failed');
      }
    });

    logoutBtn.addEventListener('click', async () => {
      try { await api('/logout', { method: 'POST' }); } catch {}
      setLoggedIn(false);
    });

    async function loadFiles() {
      fileList.innerHTML = '<li class="muted">Loadingâ€¦</li>';
      try {
        const data = await api('/api/files');
        renderFiles(data.files || []);
        await loadStorage();
      } catch (e) {
        fileList.innerHTML = '<li class="muted">Sign in to view files</li>';
      }
    }

    async function loadStorage() {
      try {
        const s = await api('/api/storage');
        if (s && typeof s.totalBytes === 'number') {
          const used = s.usedBytesUploads || 0;
          const free = s.freeBytes || 0;
          const total = s.totalBytes || 0;
          storageEl.textContent = `Storage: ${formatBytes(used)} used â€¢ ${formatBytes(free)} free of ${formatBytes(total)}`;
        }
      } catch {
        storageEl.textContent = '';
      }
    }

    function renderFiles(files) {
      currentFiles = files.slice();
      if (currentSort === 'name') {
        currentFiles.sort((a,b) => a.name.localeCompare(b.name));
      } else if (currentSort === 'size') {
        currentFiles.sort((a,b) => b.size - a.size);
      } else {
        currentFiles.sort((a,b) => b.modifiedAt - a.modifiedAt);
      }
      if (!currentFiles.length) {
        fileList.innerHTML = '<li class="muted">No files yet</li>';
        return;
      }
      fileList.innerHTML = '';
      for (const f of currentFiles) {
        const li = document.createElement('li');
        li.className = 'file';
        const kb = Math.max(1, Math.round(f.size / 1024));
        const date = new Date(f.modifiedAt).toLocaleString();
        li.innerHTML = `
          <div class="meta">
            <div class="name">${f.name}</div>
            <div class="muted">${kb} KB</div>
            <div class="muted">â€¢</div>
            <div class="muted">${date}</div>
          </div>
          <div class="actions">
            <button class="btn secondary" data-dl="${encodeURIComponent(f.name)}">Boost DL</button>
            <button class="btn danger">Delete</button>
          </div>
        `;
        li.querySelector('.btn.danger').addEventListener('click', async () => {
          if (!confirm('Delete this file?')) return;
          const res = await fetch(`/api/files/${encodeURIComponent(f.name)}`, { method: 'DELETE' });
          if (!res.ok) { alert('Failed to delete'); return; }
          await loadFiles();
        });
        li.querySelector('[data-dl]')?.addEventListener('click', () => acceleratedDownload(f.name, f.size));
        fileList.appendChild(li);
      }
    }
    tabs.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-sort]');
      if (!btn) return;
      currentSort = btn.dataset.sort;
      renderFiles(currentFiles);
    });

    async function acceleratedDownload(fileName, fileSize) {
      try {
        const url = `/file/${encodeURIComponent(fileName)}`;
        const parallel = 4;
        const chunkSize = Math.ceil(fileSize / parallel);
        const ranges = Array.from({ length: parallel }, (_, i) => ({
          start: i * chunkSize,
          end: Math.min(fileSize - 1, (i + 1) * chunkSize - 1),
        })).filter(r => r.start <= r.end);

        const parts = await Promise.all(ranges.map(async (r) => {
          const res = await fetch(url, { headers: { Range: `bytes=${r.start}-${r.end}` }, credentials: 'same-origin' });
          if (!res.ok && res.status !== 206) throw new Error('range fetch failed');
          const buf = await res.arrayBuffer();
          return { start: r.start, buf };
        }));
        parts.sort((a,b) => a.start - b.start);
        const total = parts.reduce((n,p) => n + p.buf.byteLength, 0);
        const out = new Uint8Array(total);
        let offset = 0;
        for (const p of parts) { out.set(new Uint8Array(p.buf), offset); offset += p.buf.byteLength; }

        const blob = new Blob([out]);
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(a.href);
      } catch (e) {
        // fallback
        location.href = `/download/${encodeURIComponent(fileName)}`;
      }
    }

    function formatBytes(b) {
      const units = ['B','KB','MB','GB','TB'];
      let i = 0; let v = b;
      while (v >= 1024 && i < units.length - 1) { v /= 1024; i++; }
      return `${v.toFixed(v >= 100 ? 0 : v >= 10 ? 1 : 2)} ${units[i]}`;
    }

    async function uploadFiles(files) {
      if (!files?.length) return;
      for (const file of files) {
        void uploadFileChunked(file);
      }
    }

    async function uploadFileChunked(file) {
      const chunkSize = 5 * 1024 * 1024; // 5MB
      const totalChunks = Math.ceil(file.size / chunkSize);
      const li = document.createElement('li');
      li.className = 'upload-item';
      li.innerHTML = `
        <div class="row" style="justify-content:space-between; gap:10px; align-items:center">
          <div class="name" style="flex:1; min-width:0">${file.name}</div>
          <div class="small">${formatBytes(file.size)}</div>
        </div>
        <div class="progress" style="margin-top:8px"><div></div></div>
        <div class="small" style="margin-top:6px; display:flex; gap:8px; align-items:center"><span class="pct">0%</span><span>â€¢</span><span class="speed">0 MB/s</span><span>â€¢</span><span class="eta">â€”</span></div>
      `;
      uploadsList.appendChild(li);
      const bar = li.querySelector('.progress > div');
      const pctEl = li.querySelector('.pct');
      const speedEl = li.querySelector('.speed');
      const etaEl = li.querySelector('.eta');

      const t0 = performance.now();
      let uploaded = 0;
      let lastTime = t0;
      let lastUploaded = 0;

      try {
        const initRes = await fetch('/api/upload/init', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ filename: file.name, size: file.size, chunkSize, totalChunks }),
        });
        if (!initRes.ok) throw new Error('init failed');
        const { uploadId } = await initRes.json();

        for (let i = 0; i < totalChunks; i++) {
          const start = i * chunkSize;
          const end = Math.min(file.size, start + chunkSize);
          const chunk = file.slice(start, end);

          const res = await fetch(`/api/upload/chunk?uploadId=${encodeURIComponent(uploadId)}&index=${i}` , {
            method: 'PUT',
            body: chunk,
            credentials: 'same-origin',
          });
          if (!res.ok) throw new Error('chunk failed');

          uploaded += chunk.size;
          const now = performance.now();
          const dt = (now - lastTime) / 1000;
          if (dt >= 0.3) {
            const ds = uploaded - lastUploaded;
            const speed = ds / dt; // bytes/s
            speedEl.textContent = `${(speed / (1024*1024)).toFixed(2)} MB/s`;
            const remaining = file.size - uploaded;
            const eta = speed > 0 ? remaining / speed : 0;
            etaEl.textContent = eta ? `${Math.ceil(eta)}s left` : 'â€”';
            lastTime = now;
            lastUploaded = uploaded;
          }
          const p = Math.round((uploaded / file.size) * 100);
          bar.style.width = `${p}%`;
          pctEl.textContent = `${p}%`;
        }

        const fin = await fetch('/api/upload/complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ uploadId }),
        });
        if (!fin.ok) throw new Error('complete failed');
        bar.style.width = '100%';
        pctEl.textContent = '100%';
        etaEl.textContent = 'Done';
      } catch (e) {
        li.querySelector('.name').textContent += ' â€” failed';
        bar.style.background = 'linear-gradient(90deg, #f87171, #ef4444)';
      } finally {
        await loadFiles();
        setTimeout(() => li.remove(), 1500);
      }
    }

    fileInput.addEventListener('change', (e) => uploadFiles(e.target.files));

    ;['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, (e) => {
      e.preventDefault(); e.stopPropagation();
      drop.style.borderColor = 'rgba(96,165,250,0.7)';
    }));
    ;['dragleave','drop'].forEach(ev => drop.addEventListener(ev, (e) => {
      e.preventDefault(); e.stopPropagation();
      drop.style.borderColor = 'rgba(255,255,255,0.2)';
    }));
    drop.addEventListener('drop', (e) => uploadFiles(e.dataTransfer.files));

    refreshBtn.addEventListener('click', loadFiles);
    setInterval(() => { if (authed) loadStorage(); }, 15000);

    // Attempt to load files to detect session state on first paint
    loadFiles().then(() => setLoggedIn(true)).catch(() => setLoggedIn(false));
  </script>
</body>
</html>