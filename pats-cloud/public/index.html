<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pats Cloud</title>
  <link rel="icon" href="data:," />
  <style>
    :root {
      --bg: #0b0f14;
      --surface: #121821;
      --surface-2: #0e141c;
      --text: #e6edf3;
      --muted: #9fb3c8;
      --primary: #60a5fa;
      --primary-2: #2563eb;
      --danger: #ef4444;
      --success: #22c55e;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial;
      background: radial-gradient(1200px 800px at 10% -10%, #0b1220, var(--bg)),
                  radial-gradient(800px 600px at 120% 20%, #0b1426, transparent);
      color: var(--text);
      display: grid; place-items: center;
    }
    .app {
      width: min(960px, 100%);
      padding: 16px;
    }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius);
      box-shadow: 0 20px 60px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    header.card { padding: 16px 18px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    header h1 { font-size: clamp(18px, 5vw, 22px); margin: 0; letter-spacing: 0.4px; }
    .muted { color: var(--muted); font-size: 12px; }
    .content.card { margin-top: 14px; padding: 14px; }

    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

    input[type="password"], input[type="text"], .btn, .file-input {
      border-radius: 12px; border: 1px solid rgba(255,255,255,0.14);
      background: var(--surface);
      color: var(--text);
      padding: 12px 14px; font-size: 14px;
    }
    .btn { background: linear-gradient(180deg, var(--primary), var(--primary-2)); border: none; color: white; cursor: pointer; }
    .btn.secondary { background: linear-gradient(180deg, #303a49, #202834); }
    .btn.danger { background: linear-gradient(180deg, #f87171, #ef4444); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .file-drop {
      border: 1.5px dashed rgba(255,255,255,0.2);
      border-radius: 14px;
      padding: 18px; text-align: center; color: var(--muted);
      background: var(--surface-2);
    }

    ul.files { list-style: none; margin: 0; padding: 0; display: grid; gap: 10px; }
    .file {
      display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center;
      padding: 10px; border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.08);
    }
    .file .meta { display: flex; gap: 10px; align-items: center; min-width: 0; }
    .file .name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .spacer { flex: 1; }
    .hidden { display: none !important; }

    @media (hover: hover) {
      .file:hover { border-color: rgba(255,255,255,0.22); }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="card">
      <h1>ðŸ˜» Pats Cloud</h1>
      <div class="row">
        <small id="status" class="muted">Not signed in</small>
        <button id="logoutBtn" class="btn secondary hidden">Logout</button>
      </div>
    </header>

    <section id="loginView" class="content card">
      <div class="row">
        <input id="password" type="password" inputmode="text" placeholder="Enter password" style="flex:1" />
        <button id="loginBtn" class="btn">Sign In</button>
      </div>
      <p class="muted" style="margin-top:8px">Keep this private. You can set the password via .env</p>
    </section>

    <section id="appView" class="content card hidden">
      <div class="row" style="gap:8px; align-items: stretch;">
        <label class="file-input" style="display:inline-flex; align-items:center; gap:10px; cursor:pointer;">
          <input id="fileInput" type="file" multiple style="display:none" />
          <span>Choose files</span>
        </label>
        <div class="spacer"></div>
        <button id="refreshBtn" class="btn secondary">Refresh</button>
      </div>

      <div id="drop" class="file-drop" style="margin-top:10px">Drop files here to upload</div>

      <ul id="fileList" class="files" style="margin-top:12px"></ul>
    </section>
  </div>

  <script>
    const loginView = document.getElementById('loginView');
    const appView = document.getElementById('appView');
    const statusEl = document.getElementById('status');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginBtn = document.getElementById('loginBtn');
    const passwordEl = document.getElementById('password');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const drop = document.getElementById('drop');
    const refreshBtn = document.getElementById('refreshBtn');

    let authed = false;

    async function api(path, opts = {}) {
      const res = await fetch(path, {
        ...opts,
        headers: {
          'Content-Type': 'application/json',
          ...(opts.headers || {}),
        },
        credentials: 'same-origin',
      });
      if (!res.ok) throw new Error(await res.text());
      return res.headers.get('content-type')?.includes('application/json') ? res.json() : res.text();
    }

    function setLoggedIn(v) {
      authed = v;
      loginView.classList.toggle('hidden', v);
      appView.classList.toggle('hidden', !v);
      logoutBtn.classList.toggle('hidden', !v);
      statusEl.textContent = v ? 'Signed in' : 'Not signed in';
    }

    loginBtn.addEventListener('click', async () => {
      try {
        const body = JSON.stringify({ password: passwordEl.value });
        const data = await api('/login', { method: 'POST', body });
        setLoggedIn(true);
        if (data?.warning) alert(data.warning);
        await loadFiles();
      } catch (e) {
        alert('Login failed');
      }
    });

    logoutBtn.addEventListener('click', async () => {
      try { await api('/logout', { method: 'POST' }); } catch {}
      setLoggedIn(false);
    });

    async function loadFiles() {
      fileList.innerHTML = '<li class="muted">Loadingâ€¦</li>';
      try {
        const data = await api('/api/files');
        renderFiles(data.files || []);
      } catch (e) {
        fileList.innerHTML = '<li class="muted">Sign in to view files</li>';
      }
    }

    function renderFiles(files) {
      if (!files.length) {
        fileList.innerHTML = '<li class="muted">No files yet</li>';
        return;
      }
      fileList.innerHTML = '';
      for (const f of files) {
        const li = document.createElement('li');
        li.className = 'file';
        const kb = Math.max(1, Math.round(f.size / 1024));
        const date = new Date(f.modifiedAt).toLocaleString();
        li.innerHTML = `
          <div class="meta">
            <div class="name">${f.name}</div>
            <div class="muted">${kb} KB</div>
            <div class="muted">â€¢</div>
            <div class="muted">${date}</div>
          </div>
          <div class="row" style="gap:6px">
            <a class="btn secondary" href="/download/${encodeURIComponent(f.name)}">Download</a>
            <button class="btn danger">Delete</button>
          </div>
        `;
        li.querySelector('button').addEventListener('click', async () => {
          if (!confirm('Delete this file?')) return;
          const res = await fetch(`/api/files/${encodeURIComponent(f.name)}`, { method: 'DELETE' });
          if (!res.ok) { alert('Failed to delete'); return; }
          await loadFiles();
        });
        fileList.appendChild(li);
      }
    }

    function uploadFiles(files) {
      if (!files?.length) return;
      const form = new FormData();
      for (const f of files) form.append('files', f);
      fetch('/api/upload', { method: 'POST', body: form, credentials: 'same-origin' })
        .then(async (r) => {
          if (!r.ok) throw new Error('Upload failed');
          return r.json();
        })
        .then(() => loadFiles())
        .catch(() => alert('Upload failed'));
    }

    fileInput.addEventListener('change', (e) => uploadFiles(e.target.files));

    ;['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, (e) => {
      e.preventDefault(); e.stopPropagation();
      drop.style.borderColor = 'rgba(96,165,250,0.7)';
    }));
    ;['dragleave','drop'].forEach(ev => drop.addEventListener(ev, (e) => {
      e.preventDefault(); e.stopPropagation();
      drop.style.borderColor = 'rgba(255,255,255,0.2)';
    }));
    drop.addEventListener('drop', (e) => uploadFiles(e.dataTransfer.files));

    refreshBtn.addEventListener('click', loadFiles);

    // Attempt to load files to detect session state on first paint
    loadFiles().then(() => setLoggedIn(true)).catch(() => setLoggedIn(false));
  </script>
</body>
</html>